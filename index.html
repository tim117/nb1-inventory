<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NB-1 進銷存系統 V6</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .safe-top { padding-top: env(safe-area-inset-top); }
        
        .mode-btn { transition: all 0.2s; }
        .mode-active-in { background-color: #10B981; color: white; }
        .mode-active-out { background-color: #EF4444; color: white; }
        .mode-active-order { background-color: #3B82F6; color: white; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden flex flex-col text-gray-800">

    <div id="app" class="h-full flex flex-col">
        
        <header class="bg-white shadow-sm z-20 safe-top flex-none">
            <div class="flex justify-between items-center px-4 py-3">
                <h1 class="text-lg font-bold tracking-wide">NB-1 系統</h1>
                <div v-if="currentTab === 'pos'" class="flex bg-gray-200 rounded-lg p-1 text-xs font-bold">
                    <button @click="mode = 'IN'" class="px-3 py-1.5 rounded-md mode-btn" :class="mode === 'IN' ? 'mode-active-in shadow' : 'text-gray-500'">進貨</button>
                    <button @click="mode = 'OUT'" class="px-3 py-1.5 rounded-md mode-btn" :class="mode === 'OUT' ? 'mode-active-out shadow' : 'text-gray-500'">出貨</button>
                    <button @click="mode = 'ORDER'" class="px-3 py-1.5 rounded-md mode-btn" :class="mode === 'ORDER' ? 'mode-active-order shadow' : 'text-gray-500'">叫貨</button>
                </div>
                <div v-if="currentTab === 'inventory'" class="flex space-x-3">
                    <button @click="toggleLowStockFilter" :class="showLowStockOnly ? 'text-amber-500' : 'text-gray-400'">
                        <i class="fa-solid fa-filter"></i>
                    </button>
                    <button @click="exportCSV" class="text-blue-600">
                        <i class="fa-solid fa-file-export"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-hidden relative">
            
            <div v-show="currentTab === 'pos'" class="h-full flex flex-col">
                <div v-if="mode === 'ORDER'" class="bg-blue-50 text-blue-700 text-xs text-center py-1">
                    <i class="fa-solid fa-circle-info"></i> 目前為「叫貨模式」，結帳後將存入「叫貨單」等待到貨。
                </div>

                <div class="flex-1 flex overflow-hidden">
                    <div class="w-1/4 bg-gray-50 overflow-y-auto hide-scrollbar border-r">
                        <button v-for="cat in categories" :key="cat" 
                            @click="activeCategory = cat"
                            class="w-full py-4 px-2 text-xs font-medium border-l-4 transition-all duration-200 leading-tight"
                            :class="activeCategory === cat ? 'bg-white border-gray-800 shadow-sm' : 'border-transparent text-gray-500 hover:bg-gray-100'">
                            <div class="w-full h-2 rounded mb-2" :class="getCategoryColor(cat)"></div>
                            {{ cat }}
                        </button>
                    </div>

                    <div class="w-3/4 bg-white overflow-y-auto p-2 pb-24">
                        <div class="grid grid-cols-2 gap-2">
                            <div v-for="prod in filteredProducts" :key="prod.name" 
                                @click="addToCart(prod)"
                                class="border rounded-lg p-2 shadow-sm active:scale-95 transition-transform flex flex-col justify-between h-24 relative overflow-hidden">
                                <div class="absolute top-0 right-0 px-2 py-0.5 text-xs text-white rounded-bl-lg font-bold"
                                     :class="getStockStatusColor(getStock(prod.name))">
                                    {{ getStock(prod.name) }}
                                </div>
                                <h3 class="text-sm font-bold line-clamp-2 leading-snug">{{ prod.name }}</h3>
                                <p class="text-right text-gray-500 text-xs mt-1">${{ formatPrice(prod.price) }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="cart.length > 0" class="absolute bottom-0 w-full bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-10 rounded-t-xl transition-transform duration-300">
                    <div v-if="isCartOpen" class="max-h-[50vh] overflow-y-auto p-4 bg-gray-50 border-b">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-gray-700">清單 ({{ getModeLabel(mode) }})</h3>
                            <button @click="clearCart" class="text-xs text-red-500"><i class="fa-solid fa-trash"></i> 清空</button>
                        </div>
                        <input type="text" v-model="orderMemo" placeholder="備忘錄..." class="w-full mb-3 p-2 border rounded text-sm focus:outline-none focus:border-blue-500">
                        <div v-for="(item, index) in cart" :key="index" class="flex justify-between items-center py-2 border-b last:border-0">
                            <div class="w-1/2">
                                <div class="text-sm font-medium truncate">{{ item.name }}</div>
                                <div class="text-xs text-gray-500">${{ formatPrice(item.price) }}</div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button @click="updateQty(index, -1)" class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center">-</button>
                                <span class="font-bold w-6 text-center">{{ item.qty }}</span>
                                <button @click="updateQty(index, 1)" class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 flex items-center justify-between bg-white safe-bottom">
                        <div @click="isCartOpen = !isCartOpen" class="flex flex-col cursor-pointer">
                            <span class="text-xs text-gray-500 flex items-center">
                                <i class="fa-solid" :class="isCartOpen ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
                                <span class="ml-1">共 {{ cartItemCount }} 項</span>
                            </span>
                            <span class="text-xl font-bold text-gray-800">${{ formatPrice(cartTotal) }}</span>
                        </div>
                        <button @click="checkout" 
                            class="px-8 py-3 rounded-full text-white font-bold shadow-lg transform active:scale-95 transition-colors"
                            :class="getCheckoutBtnClass()">
                            確認{{ getModeLabel(mode) }}
                        </button>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'orders'" class="h-full flex flex-col bg-gray-100 p-4 overflow-y-auto pb-24">
                <h2 class="text-xl font-bold mb-4 ml-1 flex items-center">
                    <i class="fa-solid fa-truck-fast mr-2 text-blue-600"></i>
                    叫貨/待收清單
                </h2>
                <div v-if="pendingOrders.length === 0" class="text-center text-gray-400 mt-10">
                    <i class="fa-regular fa-clipboard text-4xl mb-3"></i><br>
                    目前沒有叫貨單
                </div>
                <div v-for="order in pendingOrders" :key="order.id" class="bg-white p-4 rounded-xl shadow-sm mb-4 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">叫貨中</span>
                            <span class="text-xs text-gray-400 ml-2">{{ formatDate(order.timestamp) }}</span>
                        </div>
                        <button @click="deletePendingOrder(order.id)" class="text-gray-400 hover:text-red-500 px-2"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div v-if="order.memo" class="mb-2 text-sm text-gray-600 bg-gray-50 p-2 rounded italic">{{ order.memo }}</div>
                    <div class="border-t pt-2 mt-2 mb-3">
                        <div v-for="item in order.items" class="flex justify-between text-sm py-0.5">
                            <span class="text-gray-700 truncate w-2/3">{{ item.name }}</span>
                            <span class="font-mono">x{{ item.qty }}</span>
                        </div>
                        <div class="text-right font-bold mt-2 pt-2 border-t border-dashed text-gray-600">總金額: ${{ formatPrice(order.total) }}</div>
                    </div>
                    <button @click="receiveOrder(order)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow transition-colors flex items-center justify-center">
                        <i class="fa-solid fa-check-to-slot mr-2"></i> 確認到貨 (入庫)
                    </button>
                </div>
            </div>

            <div v-show="currentTab === 'inventory'" class="h-full flex flex-col bg-white p-4">
                <div class="mb-4 relative flex space-x-2">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" v-model="inventorySearch" placeholder="搜尋產品名稱..." class="w-full pl-10 pr-4 py-2 bg-gray-100 rounded-lg focus:outline-none">
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto hide-scrollbar">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th class="px-2 py-3">產品名稱</th>
                                <th class="px-2 py-3 text-right">售價</th>
                                <th class="px-2 py-3 text-right">盤點 <i class="fa-solid fa-pen ml-1 text-gray-400"></i></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="prod in filteredInventory" :key="prod.name" class="border-b hover:bg-gray-50">
                                <td class="px-2 py-3">
                                    <div class="font-medium text-gray-900">{{ prod.name }}</div>
                                    <div class="text-xs text-gray-500">{{ prod.category }}</div>
                                </td>
                                <td class="px-2 py-3 text-right text-gray-500">${{ formatPrice(prod.price) }}</td>
                                <td class="px-2 py-3 text-right">
                                    <button @click="quickEditStock(prod)" 
                                        class="font-bold py-1 px-3 rounded text-white min-w-[3rem]"
                                        :class="getStockStatusColor(getStock(prod.name))">
                                        {{ getStock(prod.name) }}
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-show="currentTab === 'history'" class="h-full flex flex-col bg-gray-100 p-4 overflow-y-auto pb-24">
                <h2 class="text-xl font-bold mb-4 ml-1">交易紀錄</h2>
                <div v-if="transactions.length === 0" class="text-center text-gray-400 mt-10">暫無紀錄</div>
                <div v-for="record in sortedTransactions" :key="record.id" class="bg-white p-4 rounded-xl shadow-sm mb-4 border-l-4" :class="getTransactionColor(record.type)">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs font-bold px-2 py-1 rounded" :class="getTransactionBadgeClass(record.type)">{{ getTransactionLabel(record.type) }}</span>
                            <span class="text-xs text-gray-400 ml-2">{{ formatDate(record.timestamp) }}</span>
                        </div>
                        <button @click="deleteTransaction(record)" class="text-gray-400 hover:text-red-500 px-2"><i class="fa-solid fa-trash"></i></button>
                    </div>
                    <div class="mb-2 text-sm text-gray-600 bg-gray-50 p-2 rounded flex justify-between items-center group">
                        <span v-if="!record.isEditing" class="italic w-full">{{ record.memo || '無備註' }}</span>
                        <input v-else v-model="record.tempMemo" class="bg-white border p-1 rounded w-full text-sm" />
                        <button v-if="!record.isEditing" @click="startEdit(record)" class="ml-2 text-gray-400 hover:text-blue-500"><i class="fa-solid fa-pen"></i></button>
                        <button v-else @click="saveEdit(record)" class="ml-2 text-green-500"><i class="fa-solid fa-check"></i></button>
                    </div>
                    <div class="border-t pt-2 mt-2">
                        <div v-for="item in record.items" class="flex justify-between text-sm py-0.5">
                            <span class="text-gray-700 truncate w-2/3">{{ item.name }}</span>
                            <span class="font-mono">{{ item.qty }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <nav class="bg-white border-t border-gray-200 flex justify-around items-center safe-bottom py-2 z-20">
            <button @click="currentTab = 'pos'" class="flex flex-col items-center p-2 w-1/4" :class="currentTab === 'pos' ? 'text-blue-600' : 'text-gray-400'">
                <i class="fa-solid fa-cash-register text-xl mb-1"></i><span class="text-[10px]">作業</span>
            </button>
            <button @click="currentTab = 'orders'" class="flex flex-col items-center p-2 w-1/4" :class="currentTab === 'orders' ? 'text-blue-600' : 'text-gray-400'">
                <div class="relative"><i class="fa-solid fa-truck-fast text-xl mb-1"></i><span v-if="pendingOrders.length > 0" class="absolute -top-1 -right-2 bg-red-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full">{{ pendingOrders.length }}</span></div><span class="text-[10px]">叫貨單</span>
            </button>
            <button @click="currentTab = 'inventory'" class="flex flex-col items-center p-2 w-1/4" :class="currentTab === 'inventory' ? 'text-blue-600' : 'text-gray-400'">
                <i class="fa-solid fa-boxes-stacked text-xl mb-1"></i><span class="text-[10px]">庫存</span>
            </button>
            <button @click="currentTab = 'history'" class="flex flex-col items-center p-2 w-1/4" :class="currentTab === 'history' ? 'text-blue-600' : 'text-gray-400'">
                <i class="fa-solid fa-clock-rotate-left text-xl mb-1"></i><span class="text-[10px]">紀錄</span>
            </button>
        </nav>
    </div>

    <script>
        const { createApp } = Vue;

        // --- 全新生成的產品列表 (256項) ---
        const RAW_PRODUCTS = [
            {cat:'晶鑽系列',name:'NB-1晶鑽彈力肽撫紋緊緻露 EX',price:4280},
            {cat:'晶鑽系列',name:'NB-1晶鑽肽彈力潤采凝萃 EX',price:25000},
            {cat:'晶鑽系列',name:'NB-1晶鑽肽彈力豐潤緊實精華 EX',price:16800},
            {cat:'晶鑽系列',name:'NB-1晶鑽肽彈力亮眼精華 EX',price:8800},
            {cat:'晶鑽系列',name:'NB-1晶鑽肽彈力亮眼緊緻霜 EX',price:5800},
            {cat:'晶鑽系列',name:'NB-1晶鑽肽彈力全效肌活霜 EX',price:12500},
            {cat:'NB-1御妍系列',name:'NB-1活膚精華露',price:3900},
            {cat:'NB-1御妍系列',name:'NB-1活膚賦活素',price:13600},
            {cat:'NB-1御妍系列',name:'NB-1抗皺緊膚霜',price:5000},
            {cat:'NB-1御妍系列',name:'NB-1活膚緊實敷面軟膜組合',price:7200},
            {cat:'NB-1御妍系列',name:'NB-1活膚緊實敷面組合',price:13300},
            {cat:'NB-1御妍系列',name:'NB-1深層美白精華露',price:2980},
            {cat:'NB-1御妍系列',name:'NB-1深層美白賦活素',price:11500},
            {cat:'NB-1御妍系列',name:'NB-1深層美白精華乳',price:5800},
            {cat:'NB-1御妍系列',name:'NB-1深層美白敷面軟膜組合',price:5200},
            {cat:'NB-1御妍系列',name:'NB-1深層美白敷面組合',price:12300},
            {cat:'NB-1御妍系列',name:'NB-1細緻毛孔精華露',price:2980},
            {cat:'NB-1御妍系列',name:'NB-1細緻毛孔賦活素',price:7000},
            {cat:'NB-1御妍系列',name:'NB-1面皰修護精華霜',price:4900},
            {cat:'NB-1御妍系列',name:'NB-1細緻毛孔敷面軟膜組合',price:5200},
            {cat:'NB-1御妍系列',name:'NB-1細緻毛孔敷面組合',price:11300},
            {cat:'NB-1御妍系列',name:'NB-1修護舒敏精華露',price:2980},
            {cat:'NB-1御妍系列',name:'NB-1修護舒敏賦活素',price:7000},
            {cat:'NB-1御妍系列',name:'NB-1修護舒敏精華霜',price:4900},
            {cat:'NB-1御妍系列',name:'NB-1修護舒敏敷面軟膜組合',price:5200},
            {cat:'NB-1御妍系列',name:'NB-1修護舒敏敷面組合',price:11300},
            {cat:'NB-1御妍系列',name:'NB-1 Plus駐顏奇肌白金精華素',price:20000},
            {cat:'NB-1御妍系列',name:'NB-1 Plus盈采臻亮精華素',price:12500},
            {cat:'NB-1御妍系列',name:'NB-1 Plus細緻精華素',price:9500},
            {cat:'NB-1御妍系列',name:'NB-1 Plus修護精華素',price:9500},
            {cat:'NB-1御妍系列',name:'NB-1 抗皺緊膚4D面膜',price:3480},
            {cat:'NB-1御妍系列',name:'NB-1 臻亮白皙精華液',price:5000},
            {cat:'NB-1御妍系列',name:'NB-1 盈采臻亮面膜',price:4000},
            {cat:'NB-1青春系列',name:'NB-1青春活膚胺基酸精華液',price:4900},
            {cat:'NB-1青春系列',name:'NB-1青春撫紋精華乳',price:3200},
            {cat:'NB-1青春系列',name:'NB-1青春Q彈水潤乳',price:2980},
            {cat:'NB-1青春系列',name:'NB-1青春亮白胜肽精華液',price:4000},
            {cat:'NB-1青春系列',name:'NB-1青春掃黑潤白精華液',price:3300},
            {cat:'NB-1青春系列',name:'NB-1青春嫩白精華乳',price:2800},
            {cat:'NB-1青春系列',name:'NB-1青春淨痘修護精華液',price:4000},
            {cat:'NB-1青春系列',name:'NB-1青春深層修護細緻精華液',price:3250},
            {cat:'NB-1青春系列',name:'NB-1青春細緻毛孔精華乳',price:2600},
            {cat:'NB-1青春系列',name:'NB-1青春細緻毛孔修護凝膠',price:2300},
            {cat:'NB-1青春系列',name:'NB-1青春平衡舒敏精華液',price:4000},
            {cat:'NB-1青春系列',name:'NB-1青春強效保濕舒敏精華乳',price:2900},
            {cat:'NB-1青春系列',name:'NB-1青春修護舒敏精華露',price:2400},
            {cat:'NB-1青春系列',name:'NB-1青春修護舒敏精華液',price:2800},
            {cat:'NB-1青春系列',name:'NB-1青春修護舒敏賦活素',price:8300},
            {cat:'NB-1青春系列',name:'NB-1青春修護舒敏精華霜',price:2500},
            {cat:'NB-1青春系列',name:'NB-1青春修護舒敏面膜',price:3800},
            {cat:'NB-1青春系列',name:'NB-1保濕卸妝乳',price:1200},
            {cat:'NB-1青春系列',name:'NB-1保濕洗面乳',price:1200},
            {cat:'NB-1青春系列',name:'NB-1青春無痕眼部賦活素',price:5300},
            {cat:'NB-1青春系列',name:'NB-1青春眼周撫紋精華乳',price:1600},
            {cat:'NB-1青春系列',name:'NB-1眼唇護膜',price:2380},
            {cat:'NB-1青春系列',name:'NB-1青春美眸眼膜',price:2200},
            {cat:'NB-1青春系列',name:'NB-1青春全效煥采保濕面膜',price:2160},
            {cat:'NB-1青春系列',name:'NB-1青春無瑕潤妍BB霜',price:2400},
            {cat:'山藥系列',name:'山藥膠原潤膚露',price:2980},
            {cat:'山藥系列',name:'山藥膠原緊緻液',price:4980},
            {cat:'山藥系列',name:'山藥膠原緊緻霜',price:4980},
            {cat:'山藥系列',name:'山藥膠原日霜',price:2800},
            {cat:'山藥系列',name:'山藥膠原緊緻眼周凝露',price:2680},
            {cat:'山藥系列',name:'山藥膠原緊緻敷面組合',price:6200},
            {cat:'山藥系列',name:'山藥膠原緊緻專業面膜',price:5500},
            {cat:'山藥系列',name:'山藥膠原身體美膚凝乳',price:1980},
            {cat:'山藥系列',name:'山藥膠原局部緊膚凝乳',price:1980},
            {cat:'Dr.標靶系列',name:'標靶水光胜肽抗皺精萃液',price:19800},
            {cat:'Dr.標靶系列',name:'標靶水光胜肽抗皺精萃液 5ml*15入(自用)',price:56430},
            {cat:'Dr.標靶系列',name:'標靶水光胜肽潔皙精萃液',price:15300},
            {cat:'Dr.標靶系列',name:'標靶水光胜肽亮采精萃液',price:13000},
            {cat:'Dr.標靶系列',name:'標靶水光胜肽細緻抗痘精萃液',price:13000},
            {cat:'Dr.標靶系列',name:'標靶水光胜肽細緻毛孔精萃液',price:13000},
            {cat:'Dr.標靶系列',name:'標靶水光修護精萃液',price:13000},
            {cat:'Dr.標靶系列',name:'標靶水光舒緩精萃液',price:13000},
            {cat:'Dr.標靶系列',name:'標靶水光玻尿酸精萃液',price:8500},
            {cat:'Dr.標靶系列',name:'標靶水光百萃修護凝凍',price:2300},
            {cat:'童妍水光系列',name:'童妍水光標靶極線立提晶萃',price:9900},
            {cat:'童妍水光系列',name:'童妍水光標靶極亮晶瓷晶萃',price:6500},
            {cat:'童妍水光系列',name:'童妍水光標靶極淨煥膚晶萃',price:6500},
            {cat:'童妍水光系列',name:'童妍水光標靶極能活護晶萃',price:6500},
            {cat:'NB-1胜肽水光',name:'胜肽水光標靶微導機能液',price:3980},
            {cat:'NB-1胜肽水光',name:'Dr. NB1水光泌齡靚白精萃液 5ml*5入',price:15800},
            {cat:'NB-1胜肽水光',name:'Dr. NB1水光泌齡靚白精萃液 5ml*15入(自用)',price:45030},
            {cat:'超效保濕系列',name:'超效保濕水光精華露',price:2980},
            {cat:'超效保濕系列',name:'超效保濕水光精華液',price:2280},
            {cat:'超效保濕系列',name:'超效保濕甦活水凝霜',price:2180},
            {cat:'超效保濕系列',name:'超效保濕滋養晚霜',price:2480},
            {cat:'超效保濕系列',name:'物理性水光瑩潤防曬素顏乳',price:2580},
            {cat:'超效保濕系列',name:'超效彈潤水光眼部賦活霜',price:2480},
            {cat:'超效保濕系列',name:'超效彈潤水光眼部精萃',price:2680},
            {cat:'超效保濕系列',name:'超效保濕按摩卸妝膏',price:1280},
            {cat:'超效保濕系列',name:'超效保濕水光潔顏乳',price:1180},
            {cat:'超效保濕系列',name:'r-PGA超效保濕爆水氣墊面膜',price:1500},
            {cat:'其他系列',name:'85%胺基酸深層淨化洗面乳',price:1380},
            {cat:'其他系列',name:'18%煥新靜膚酸精華',price:1680},
            {cat:'其他系列',name:'大馬士革玫瑰精萃噴霧',price:680},
            {cat:'其他系列',name:'大馬士革玫瑰賦活油',price:1490},
            {cat:'生化系列',name:'生化潔皙麗膚水',price:2100},
            {cat:'生化系列',name:'生化潔皙精華液',price:3900},
            {cat:'生化系列',name:'生化潔皙精華霜',price:3300},
            {cat:'生化系列',name:'生化潔皙隔離霜',price:2500},
            {cat:'生化系列',name:'生化潔皙敷面組合',price:9700},
            {cat:'生化系列',name:'生化平衡麗膚水',price:2100},
            {cat:'生化系列',name:'生化平衡精華液',price:2300},
            {cat:'生化系列',name:'生化平衡精華霜',price:3000},
            {cat:'生化系列',name:'生化平衡隔離霜',price:2500},
            {cat:'生化系列',name:'生化平衡敷面組合',price:9700},
            {cat:'生化系列',name:'生化雪膚麗膚水',price:2100},
            {cat:'生化系列',name:'生化雪膚精華液',price:3900},
            {cat:'生化系列',name:'生化雪膚精華霜',price:2500},
            {cat:'生化系列',name:'生化雪膚隔離霜',price:2500},
            {cat:'生化系列',name:'生化雪膚敷面組合',price:9700},
            {cat:'生化系列',name:'生化舒敏麗膚水',price:2100},
            {cat:'生化系列',name:'生化舒敏精華液',price:2640},
            {cat:'生化系列',name:'生化舒敏精華霜',price:2640},
            {cat:'生化系列',name:'生化舒敏隔離霜',price:2500},
            {cat:'生化系列',name:'生化舒敏敷面組合',price:9700},
            {cat:'生化系列',name:'生化眼周精華液',price:3300},
            {cat:'生化系列',name:'生化護唇露',price:1200},
            {cat:'生化系列',name:'生化平衡潤膚霜',price:1780},
            {cat:'生化系列',name:'生化更新凝露',price:1100},
            {cat:'生化系列',name:'生化保濕清潔乳',price:950},
            {cat:'生化系列',name:'生化平衡清潔乳',price:950},
            {cat:'生化系列',name:'生化保濕洗面乳',price:950},
            {cat:'生化系列',name:'生化平衡洗面乳',price:950},
            {cat:'生化系列',name:'水潤舒敏面膜',price:2200},
            {cat:'生化系列',name:'物理性美白防曬乳',price:2350},
            {cat:'生化系列',name:'物理性美白防曬隔離乳',price:2400},
            {cat:'生化系列',name:'生化保濕蜜粉(淺膚色)',price:1500},
            {cat:'漢方草本系列',name:'海藻麗膚水',price:920},
            {cat:'漢方草本系列',name:'海藻精華液',price:2400},
            {cat:'漢方草本系列',name:'海藻美膚霜',price:1400},
            {cat:'漢方草本系列',name:'海藻美膚隔離霜',price:1400},
            {cat:'漢方草本系列',name:'海藻美膚面膜',price:1300},
            {cat:'漢方草本系列',name:'海藻敷面組合',price:3560},
            {cat:'漢方草本系列',name:'蜂膠清潔霜',price:780},
            {cat:'漢方草本系列',name:'蜂膠清潔乳',price:400},
            {cat:'漢方草本系列',name:'蜂膠麗膚水',price:920},
            {cat:'漢方草本系列',name:'蜂膠精華液',price:2400},
            {cat:'漢方草本系列',name:'蜂膠精華霜',price:1400},
            {cat:'漢方草本系列',name:'蜂膠隔離霜',price:1400},
            {cat:'漢方草本系列',name:'蜂膠精華面膜',price:1300},
            {cat:'漢方草本系列',name:'蜂膠敷面組合',price:3560},
            {cat:'漢方草本系列',name:'生氧清潔乳',price:400},
            {cat:'漢方草本系列',name:'生氧麗膚水',price:920},
            {cat:'漢方草本系列',name:'生氧精華液',price:2800},
            {cat:'漢方草本系列',name:'生氧潤膚霜',price:1400},
            {cat:'漢方草本系列',name:'生氧潤膚隔離霜',price:1400},
            {cat:'漢方草本系列',name:'生氧潤膚面膜',price:1300},
            {cat:'漢方草本系列',name:'生氧敷面組合',price:3560},
            {cat:'漢方草本系列',name:'植物清潔霜',price:780},
            {cat:'漢方草本系列',name:'植物清潔乳',price:400},
            {cat:'漢方草本系列',name:'植物麗膚水',price:920},
            {cat:'漢方草本系列',name:'植物精華液',price:2600},
            {cat:'漢方草本系列',name:'植物潤膚霜',price:1500},
            {cat:'漢方草本系列',name:'植物潤膚隔離霜',price:1400},
            {cat:'漢方草本系列',name:'植物潤膚面膜',price:1300},
            {cat:'漢方草本系列',name:'漢方植物敷面組合',price:3560},
            {cat:'漢方草本系列',name:'潔膚霜(中油性)',price:490},
            {cat:'漢方草本系列',name:'潔膚霜(中乾性)',price:490},
            {cat:'漢方草本系列',name:'潔膚霜(敏弱)',price:490},
            {cat:'漢方草本系列',name:'清潔乳液(中油性)',price:530},
            {cat:'漢方草本系列',name:'清潔乳液(中乾性)',price:530},
            {cat:'漢方草本系列',name:'清潔乳液(敏弱)',price:530},
            {cat:'漢方草本系列',name:'美膚露(中油性)',price:1050},
            {cat:'漢方草本系列',name:'美膚露(中乾姓)',price:1050},
            {cat:'漢方草本系列',name:'美膚露(敏弱)',price:1050},
            {cat:'漢方草本系列',name:'平衡麗膚霜',price:430},
            {cat:'漢方草本系列',name:'平衡調理精華液',price:2200},
            {cat:'漢方草本系列',name:'植物面皰精華霜',price:2050},
            {cat:'漢方草本系列',name:'潤膚眼霜(B16)',price:1030},
            {cat:'漢方草本系列',name:'護唇霜(B9)',price:870},
            {cat:'漢方草本系列',name:'平衡潤膚霜(6A)',price:930},
            {cat:'漢方草本系列',name:'護膚霜(B1)',price:640},
            {cat:'漢方草本系列',name:'麗膚霜(6B2)',price:690},
            {cat:'漢方草本系列',name:'潤膚霜(B42)',price:970},
            {cat:'專業系列',name:'滋潤化妝水',price:780},
            {cat:'專業系列',name:'保濕乳液(滋潤型)',price:1500},
            {cat:'專業系列',name:'舒敏精華乳(第二代)',price:980},
            {cat:'專業系列',name:'保濕除皺精華液',price:2380},
            {cat:'專業系列',name:'平衡面皰霜',price:730},
            {cat:'專業系列',name:'水嫩喝水果凍',price:1620},
            {cat:'專業系列',name:'玻尿酸保濕面膜組合',price:1950},
            {cat:'專業系列',name:'自然美防曬粉底',price:1400},
            {cat:'專業系列',name:'自然美物理性美白防曬乳(Body)',price:1100},
            {cat:'專業系列',name:'天然精油洗手乳',price:570},
            {cat:'專業系列',name:'金縷梅沐浴乳',price:340},
            {cat:'專業系列',name:'酪梨油沐髮乳',price:350},
            {cat:'精油系列',name:'淨化複方精油',price:1350},
            {cat:'精油系列',name:'細緻毛孔複方精油',price:1350},
            {cat:'精油系列',name:'雪膚複方精油',price:1350},
            {cat:'精油系列',name:'煥顏複方精油',price:3000},
            {cat:'精油系列',name:'舒敏複方精油',price:1350},
            {cat:'精油系列',name:'亮眼複方精油',price:1350},
            {cat:'精油系列',name:'緊膚複方精油',price:3000},
            {cat:'精油系列',name:'舒緩按摩精油',price:2250},
            {cat:'精油系列',name:'活絡舒壓按摩精油',price:2500},
            {cat:'精油系列',name:'甦活舒體按摩精油',price:2900},
            {cat:'精油系列',name:'金品活絡舒壓按摩油',price:3100},
            {cat:'精油系列',name:'金品愉悅放鬆按摩精油',price:3800},
            {cat:'精油系列',name:'日光複方按摩精油',price:5900},
            {cat:'精油系列',name:'月光複方按摩精油',price:5900},
            {cat:'精油系列',name:'金/火象複方按摩精油',price:5900},
            {cat:'精油系列',name:'木/土水象複方按摩精油',price:5900},
            {cat:'精油系列',name:'頂級薰衣草精油',price:1550},
            {cat:'精油系列',name:'頂級歐薄荷精油',price:1050},
            {cat:'精油系列',name:'甜橙精油',price:700},
            {cat:'精油系列',name:'萊姆精油',price:940},
            {cat:'精油系列',name:'迷迭香精油',price:1290},
            {cat:'精油系列',name:'佛手柑精油',price:1500},
            {cat:'精油系列',name:'天竺葵精油',price:1870},
            {cat:'精油系列',name:'澳洲尤加利精油',price:680},
            {cat:'精油系列',name:'活絡舒壓水療浴油',price:3500},
            {cat:'精油系列',name:'舒壓除勞水療浴油',price:2600},
            {cat:'保健系列',name:'好強鈣',price:880},
            {cat:'保健系列',name:'好元氣',price:880},
            {cat:'保健系列',name:'好美妍飲',price:2980},
            {cat:'保健系列',name:'好好睡',price:1880},
            {cat:'保健系列',name:'好順暢粉',price:1980},
            {cat:'保健系列',name:'好速活',price:1980},
            {cat:'保健系列',name:'好靈敏',price:1880},
            {cat:'保健系列',name:'好孅盈',price:1880},
            {cat:'保健系列',name:'好舒息',price:1980},
            {cat:'保健系列',name:'好視界',price:1980},
            {cat:'保健系列',name:'賦源強健養髮液 90ml',price:3680},
            {cat:'保健系列',name:'賦源強健養髮液 90ml+補充瓶 200ml',price:8280},
            {cat:'保健系列',name:'賦源強健養髮液 200ml(補充瓶)',price:4880},
            {cat:'保健系列',name:'NB賦源強健洗髮露 500ml',price:880},
            {cat:'保健系列',name:'高溶氧水',price:912},
            {cat:'白藜蘆醇系列',name:'白藜蘆醇活顏精粹露',price:4280},
            {cat:'白藜蘆醇系列',name:'白藜蘆醇活顏精粹素',price:6500},
            {cat:'白藜蘆醇系列',name:'白藜蘆醇活顏精萃乳液',price:5380},
            {cat:'白藜蘆醇系列',name:'白藜蘆醇活顏精粹霜',price:6500},
            {cat:'白藜蘆醇系列',name:'白藜蘆醇活顏精粹面膜 25ml*7片',price:2880},
            {cat:'白藜蘆醇系列',name:'白藜蘆醇活顏敷面組',price:8800},
            {cat:'白藜蘆醇系列',name:'白藜蘆醇活顏精粹噴霧',price:1980},
            {cat:'白藜蘆醇系列',name:'白藜蘆醇活顏精慕斯',price:1680},
            {cat:'自用材料系列',name:'芳香植物按摩油 1088',price:620},
            {cat:'自用材料系列',name:'深層清潔乳 1175',price:670},
            {cat:'自用材料系列',name:'潔膚粉 610',price:350},
            {cat:'自用材料系列',name:'敷面露 1772',price:1010},
            {cat:'自用材料系列',name:'植物麗膚水 912',price:520},
            {cat:'自用材料系列',name:'大白冷',price:230},
            {cat:'自用材料系列',name:'大綠冷',price:230},
            {cat:'自用材料系列',name:'第二代水光儀筆具',price:750},
            {cat:'自用材料系列',name:'第二代水光儀氣管',price:1000},
            {cat:'自用材料系列',name:'NB1水光麗膚水',price:540},
            {cat:'自用材料系列',name:'玫瑰花蜜精萃',price:2980},
            {cat:'自用材料系列',name:'淨白美膚精華霜',price:2480},
            {cat:'自用材料系列',name:'修護晶露',price:2400},
            {cat:'自用材料系列',name:'修護美膚精華霜',price:2480},
            {cat:'自用材料系列',name:'水潤晶露',price:2400},
            {cat:'自用材料系列',name:'水潤美膚精華霜',price:2480},
            {cat:'自用材料系列',name:'緊緻晶露',price:2400},
            {cat:'自用材料系列',name:'緊緻美膚精華霜',price:2480}
        ];

        // --- 顏色配置 (已更新) ---
        const CATEGORY_COLORS = {
            '晶鑽系列': 'bg-gray-300 text-gray-800',
            'NB-1御妍系列': 'bg-amber-800 text-white',
            'NB-1青春系列': 'bg-yellow-500 text-white',
            '山藥系列': 'bg-green-600 text-white',
            'Dr.標靶系列': 'bg-teal-400 text-white',
            '童妍水光系列': 'bg-red-500 text-white',
            'NB-1胜肽水光': 'bg-purple-300 text-purple-900',
            '超效保濕系列': 'bg-gray-700 text-white',
            '生化系列': 'bg-purple-800 text-white',
            '漢方草本系列': 'bg-lime-700 text-white',
            '專業系列': 'bg-blue-600 text-white',
            '精油系列': 'bg-indigo-600 text-white',
            '保健系列': 'bg-pink-500 text-white',
            '其他系列': 'bg-gray-500 text-white',
            '白藜蘆醇系列': 'bg-red-800 text-white',
            '自用材料系列': 'bg-cyan-200 text-cyan-900',
        };

        createApp({
            data() {
                return {
                    currentTab: 'pos',
                    mode: 'IN', // IN, OUT, ORDER
                    categories: [],
                    products: RAW_PRODUCTS,
                    activeCategory: '',
                    inventory: {}, 
                    transactions: [],
                    pendingOrders: [],
                    cart: [],
                    isCartOpen: true,
                    orderMemo: '',
                    inventorySearch: '',
                    safeStockThreshold: 3,
                    showLowStockOnly: false
                }
            },
            created() {
                this.categories = [...new Set(this.products.map(p => p.cat))];
                this.activeCategory = this.categories[0];
                
                const savedInv = localStorage.getItem('nb1_inventory');
                if (savedInv) this.inventory = JSON.parse(savedInv);
                
                const savedTrans = localStorage.getItem('nb1_transactions');
                if (savedTrans) this.transactions = JSON.parse(savedTrans);

                const savedOrders = localStorage.getItem('nb1_pending_orders');
                if (savedOrders) this.pendingOrders = JSON.parse(savedOrders);
            },
            computed: {
                filteredProducts() {
                    return this.products.filter(p => p.cat === this.activeCategory);
                },
                filteredInventory() {
                    let list = this.products;
                    if (this.inventorySearch) {
                        const term = this.inventorySearch.toLowerCase();
                        list = list.filter(p => p.name.toLowerCase().includes(term));
                    }
                    if (this.showLowStockOnly) {
                        list = list.filter(p => (this.inventory[p.name] || 0) < this.safeStockThreshold);
                    }
                    return list;
                },
                cartTotal() {
                    return this.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                },
                cartItemCount() {
                    return this.cart.reduce((sum, item) => sum + item.qty, 0);
                },
                sortedTransactions() {
                    return [...this.transactions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                }
            },
            methods: {
                getCategoryColor(cat) { return CATEGORY_COLORS[cat] || 'bg-gray-400 text-white'; },
                formatPrice(p) { return p.toLocaleString(); },
                formatDate(dStr) {
                    const d = new Date(dStr);
                    return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                },
                getStock(name) { return this.inventory[name] || 0; },
                getStockStatusColor(qty) {
                    if (qty <= 0) return 'bg-red-500 text-white';
                    if (qty < this.safeStockThreshold) return 'bg-amber-400 text-white';
                    return 'bg-green-500 text-white';
                },
                getModeLabel(m) {
                    if (m === 'IN') return '進貨';
                    if (m === 'OUT') return '出貨';
                    return '叫貨';
                },
                getCheckoutBtnClass() {
                    if (this.mode === 'IN') return 'bg-green-500 hover:bg-green-600';
                    if (this.mode === 'OUT') return 'bg-red-500 hover:bg-red-600';
                    return 'bg-blue-500 hover:bg-blue-600';
                },
                getTransactionColor(type) {
                    if (type === 'IN') return 'border-green-500';
                    if (type === 'OUT') return 'border-red-500';
                    if (type === 'CORRECT') return 'border-gray-500';
                    return 'border-blue-500';
                },
                getTransactionBadgeClass(type) {
                    if (type === 'IN') return 'bg-green-100 text-green-700';
                    if (type === 'OUT') return 'bg-red-100 text-red-700';
                    if (type === 'CORRECT') return 'bg-gray-100 text-gray-700';
                    return 'bg-blue-100 text-blue-700';
                },
                getTransactionLabel(type) {
                    if (type === 'IN') return '一般進貨';
                    if (type === 'OUT') return '銷售出貨';
                    if (type === 'CORRECT') return '盤點校正';
                    return '叫貨入庫';
                },
                addToCart(product) {
                    const existing = this.cart.find(item => item.name === product.name);
                    if (existing) existing.qty++;
                    else this.cart.push({ ...product, qty: 1 });
                },
                updateQty(index, change) {
                    this.cart[index].qty += change;
                    if (this.cart[index].qty <= 0) this.cart.splice(index, 1);
                },
                clearCart() {
                    this.cart = [];
                    this.orderMemo = '';
                },
                checkout() {
                    if (this.cart.length === 0) return;
                    if (this.mode === 'ORDER') {
                        const order = {
                            id: Date.now(),
                            timestamp: new Date().toISOString(),
                            items: JSON.parse(JSON.stringify(this.cart)),
                            total: this.cartTotal,
                            memo: this.orderMemo
                        };
                        this.pendingOrders.push(order);
                        this.saveToLocal();
                        this.clearCart();
                        alert('叫貨單已建立！請至「叫貨單」分頁查看。');
                        return;
                    }
                    const transaction = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: this.mode,
                        items: JSON.parse(JSON.stringify(this.cart)), 
                        total: this.cartTotal,
                        memo: this.orderMemo,
                        isEditing: false, 
                        tempMemo: ''
                    };
                    this.cart.forEach(item => {
                        const current = this.inventory[item.name] || 0;
                        if (this.mode === 'IN') this.inventory[item.name] = current + item.qty;
                        else this.inventory[item.name] = current - item.qty;
                    });
                    this.transactions.push(transaction);
                    this.saveToLocal();
                    this.clearCart();
                    alert(this.mode === 'IN' ? '進貨完成！' : '出貨完成！');
                },
                receiveOrder(order) {
                    if (!confirm('確認貨品已送達？這將會把數量加入庫存。')) return;
                    order.items.forEach(item => {
                        const current = this.inventory[item.name] || 0;
                        this.inventory[item.name] = current + item.qty;
                    });
                    const transaction = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'ORDER_IN',
                        items: order.items,
                        total: order.total,
                        memo: `[到貨] ${order.memo || ''}`,
                        isEditing: false,
                        tempMemo: ''
                    };
                    this.transactions.push(transaction);
                    this.pendingOrders = this.pendingOrders.filter(o => o.id !== order.id);
                    this.saveToLocal();
                    alert('已完成入庫！');
                },
                deletePendingOrder(id) {
                    if(confirm('確定要刪除此叫貨單嗎？(尚未入庫)')) {
                        this.pendingOrders = this.pendingOrders.filter(o => o.id !== id);
                        this.saveToLocal();
                    }
                },
                quickEditStock(prod) {
                    const currentQty = this.getStock(prod.name);
                    const newQtyStr = prompt(`盤點「${prod.name}」實際數量：`, currentQty);
                    if (newQtyStr === null) return;
                    const newQty = parseInt(newQtyStr);
                    if (isNaN(newQty) || newQty < 0) { alert("無效數字"); return; }
                    if (newQty === currentQty) return;
                    const transaction = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'CORRECT',
                        items: [{ name: prod.name, qty: newQty, oldQty: currentQty }],
                        total: 0,
                        memo: `快速盤點修正 (${currentQty} -> ${newQty})`,
                        isEditing: false, tempMemo: ''
                    };
                    this.inventory[prod.name] = newQty;
                    this.transactions.push(transaction);
                    this.saveToLocal();
                },
                deleteTransaction(record) {
                    if(!confirm('刪除紀錄將自動校正庫存，確定？')) return;
                    if (record.type === 'CORRECT') {
                        alert('盤點紀錄僅刪除資料，不影響當前庫存');
                    } else {
                        const isStockIn = (record.type === 'IN' || record.type === 'ORDER_IN');
                        record.items.forEach(item => {
                            const current = this.inventory[item.name] || 0;
                            if (isStockIn) this.inventory[item.name] = current - item.qty;
                            else this.inventory[item.name] = current + item.qty;
                        });
                    }
                    this.transactions = this.transactions.filter(t => t.id !== record.id);
                    this.saveToLocal();
                },
                startEdit(record) { record.tempMemo = record.memo; record.isEditing = true; },
                saveEdit(record) { record.memo = record.tempMemo; record.isEditing = false; this.saveToLocal(); },
                toggleLowStockFilter() { this.showLowStockOnly = !this.showLowStockOnly; },
                exportCSV() {
                    const headers = ["類別", "產品名稱", "建議售價", "目前庫存"];
                    const rows = this.products.map(p => [p.cat, p.name, p.price, this.getStock(p.name)]);
                    let csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(",") + "\n" + rows.join("\n");
                    const link = document.createElement("a");
                    link.setAttribute("href", encodeURI(csvContent));
                    link.setAttribute("download", `NB1_Inv_${new Date().toISOString().slice(0,10)}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
                saveToLocal() {
                    localStorage.setItem('nb1_inventory', JSON.stringify(this.inventory));
                    localStorage.setItem('nb1_transactions', JSON.stringify(this.transactions));
                    localStorage.setItem('nb1_pending_orders', JSON.stringify(this.pendingOrders));
                }
            }
        }).mount('#app');
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js').then(reg => {
                reg.onupdatefound = () => {
                    const installingWorker = reg.installing;
                    installingWorker.onstatechange = () => {
                        if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                            console.log('New content is available; please refresh.');
                        }
                    };
                };
            });
        }
    </script>
</body>
</html>
