<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NB-1 進銷存 v3</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .safe-top { padding-top: env(safe-area-inset-top); }
        
        /* 三段式切換按鈕樣式 */
        .mode-btn { transition: all 0.2s; }
        .mode-active-in { background-color: #10B981; color: white; } /* 綠 */
        .mode-active-out { background-color: #EF4444; color: white; } /* 紅 */
        .mode-active-order { background-color: #3B82F6; color: white; } /* 藍 */
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden flex flex-col text-gray-800">

    <div id="app" class="h-full flex flex-col">
        
        <header class="bg-white shadow-sm z-20 safe-top flex-none">
            <div class="flex justify-between items-center px-4 py-3">
                <h1 class="text-lg font-bold tracking-wide">NB-1 系統</h1>
                
                <div v-if="currentTab === 'pos'" class="flex bg-gray-200 rounded-lg p-1 text-xs font-bold">
                    <button @click="mode = 'IN'" class="px-3 py-1.5 rounded-md mode-btn" :class="mode === 'IN' ? 'mode-active-in shadow' : 'text-gray-500'">進貨</button>
                    <button @click="mode = 'OUT'" class="px-3 py-1.5 rounded-md mode-btn" :class="mode === 'OUT' ? 'mode-active-out shadow' : 'text-gray-500'">出貨</button>
                    <button @click="mode = 'ORDER'" class="px-3 py-1.5 rounded-md mode-btn" :class="mode === 'ORDER' ? 'mode-active-order shadow' : 'text-gray-500'">叫貨</button>
                </div>

                <div v-if="currentTab === 'inventory'" class="flex space-x-3">
                    <button @click="toggleLowStockFilter" :class="showLowStockOnly ? 'text-amber-500' : 'text-gray-400'">
                        <i class="fa-solid fa-filter"></i>
                    </button>
                    <button @click="exportCSV" class="text-blue-600">
                        <i class="fa-solid fa-file-export"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-hidden relative">
            
            <div v-show="currentTab === 'pos'" class="h-full flex flex-col">
                <div v-if="mode === 'ORDER'" class="bg-blue-50 text-blue-700 text-xs text-center py-1">
                    <i class="fa-solid fa-circle-info"></i> 目前為「叫貨模式」，結帳後將存入「叫貨單」等待到貨。
                </div>

                <div class="flex-1 flex overflow-hidden">
                    <div class="w-1/4 bg-gray-50 overflow-y-auto hide-scrollbar border-r">
                        <button v-for="cat in categories" :key="cat" 
                            @click="activeCategory = cat"
                            class="w-full py-4 px-2 text-xs font-medium border-l-4 transition-all duration-200 leading-tight"
                            :class="activeCategory === cat ? 'bg-white border-gray-800 shadow-sm' : 'border-transparent text-gray-500 hover:bg-gray-100'">
                            <div class="w-full h-2 rounded mb-2" :class="getCategoryColor(cat)"></div>
                            {{ cat }}
                        </button>
                    </div>

                    <div class="w-3/4 bg-white overflow-y-auto p-2 pb-24">
                        <div class="grid grid-cols-2 gap-2">
                            <div v-for="prod in filteredProducts" :key="prod.name" 
                                @click="addToCart(prod)"
                                class="border rounded-lg p-2 shadow-sm active:scale-95 transition-transform flex flex-col justify-between h-24 relative overflow-hidden">
                                <div class="absolute top-0 right-0 px-2 py-0.5 text-xs text-white rounded-bl-lg font-bold"
                                     :class="getStockStatusColor(getStock(prod.name))">
                                    {{ getStock(prod.name) }}
                                </div>
                                <h3 class="text-sm font-bold line-clamp-2 leading-snug">{{ prod.name }}</h3>
                                <p class="text-right text-gray-500 text-xs mt-1">${{ formatPrice(prod.price) }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="cart.length > 0" class="absolute bottom-0 w-full bg-white shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-10 rounded-t-xl transition-transform duration-300">
                    <div v-if="isCartOpen" class="max-h-[50vh] overflow-y-auto p-4 bg-gray-50 border-b">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-gray-700">清單 ({{ getModeLabel(mode) }})</h3>
                            <button @click="clearCart" class="text-xs text-red-500"><i class="fa-solid fa-trash"></i> 清空</button>
                        </div>
                        <input type="text" v-model="orderMemo" placeholder="備忘錄..." class="w-full mb-3 p-2 border rounded text-sm focus:outline-none focus:border-blue-500">
                        <div v-for="(item, index) in cart" :key="index" class="flex justify-between items-center py-2 border-b last:border-0">
                            <div class="w-1/2">
                                <div class="text-sm font-medium truncate">{{ item.name }}</div>
                                <div class="text-xs text-gray-500">${{ formatPrice(item.price) }}</div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button @click="updateQty(index, -1)" class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center">-</button>
                                <span class="font-bold w-6 text-center">{{ item.qty }}</span>
                                <button @click="updateQty(index, 1)" class="w-6 h-6 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center">+</button>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 flex items-center justify-between bg-white safe-bottom">
                        <div @click="isCartOpen = !isCartOpen" class="flex flex-col cursor-pointer">
                            <span class="text-xs text-gray-500 flex items-center">
                                <i class="fa-solid" :class="isCartOpen ? 'fa-chevron-down' : 'fa-chevron-up'"></i>
                                <span class="ml-1">共 {{ cartItemCount }} 項</span>
                            </span>
                            <span class="text-xl font-bold text-gray-800">${{ formatPrice(cartTotal) }}</span>
                        </div>
                        <button @click="checkout" 
                            class="px-8 py-3 rounded-full text-white font-bold shadow-lg transform active:scale-95 transition-colors"
                            :class="getCheckoutBtnClass()">
                            確認{{ getModeLabel(mode) }}
                        </button>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'orders'" class="h-full flex flex-col bg-gray-100 p-4 overflow-y-auto pb-24">
                <h2 class="text-xl font-bold mb-4 ml-1 flex items-center">
                    <i class="fa-solid fa-truck-fast mr-2 text-blue-600"></i>
                    叫貨/待收清單
                </h2>
                <div v-if="pendingOrders.length === 0" class="text-center text-gray-400 mt-10">
                    <i class="fa-regular fa-clipboard text-4xl mb-3"></i><br>
                    目前沒有叫貨單
                </div>

                <div v-for="order in pendingOrders" :key="order.id" class="bg-white p-4 rounded-xl shadow-sm mb-4 border-l-4 border-blue-500">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded">叫貨中</span>
                            <span class="text-xs text-gray-400 ml-2">{{ formatDate(order.timestamp) }}</span>
                        </div>
                        <button @click="deletePendingOrder(order.id)" class="text-gray-400 hover:text-red-500 px-2">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                    
                    <div v-if="order.memo" class="mb-2 text-sm text-gray-600 bg-gray-50 p-2 rounded italic">
                        {{ order.memo }}
                    </div>

                    <div class="border-t pt-2 mt-2 mb-3">
                        <div v-for="item in order.items" class="flex justify-between text-sm py-0.5">
                            <span class="text-gray-700 truncate w-2/3">{{ item.name }}</span>
                            <span class="font-mono">x{{ item.qty }}</span>
                        </div>
                        <div class="text-right font-bold mt-2 pt-2 border-t border-dashed text-gray-600">
                            總金額: ${{ formatPrice(order.total) }}
                        </div>
                    </div>

                    <button @click="receiveOrder(order)" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow transition-colors flex items-center justify-center">
                        <i class="fa-solid fa-check-to-slot mr-2"></i> 確認到貨 (入庫)
                    </button>
                </div>
            </div>

            <div v-show="currentTab === 'inventory'" class="h-full flex flex-col bg-white p-4">
                <div class="mb-4 relative flex space-x-2">
                    <div class="relative flex-1">
                        <i class="fa-solid fa-search absolute left-3 top-3 text-gray-400"></i>
                        <input type="text" v-model="inventorySearch" placeholder="搜尋產品名稱..." class="w-full pl-10 pr-4 py-2 bg-gray-100 rounded-lg focus:outline-none">
                    </div>
                </div>
                <div class="flex-1 overflow-y-auto hide-scrollbar">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0 z-10">
                            <tr>
                                <th class="px-2 py-3">產品名稱</th>
                                <th class="px-2 py-3 text-right">售價</th>
                                <th class="px-2 py-3 text-right">盤點 <i class="fa-solid fa-pen ml-1 text-gray-400"></i></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="prod in filteredInventory" :key="prod.name" class="border-b hover:bg-gray-50">
                                <td class="px-2 py-3">
                                    <div class="font-medium text-gray-900">{{ prod.name }}</div>
                                    <div class="text-xs text-gray-500">{{ prod.category }}</div>
                                </td>
                                <td class="px-2 py-3 text-right text-gray-500">${{ formatPrice(prod.price) }}</td>
                                <td class="px-2 py-3 text-right">
                                    <button @click="quickEditStock(prod)" 
                                        class="font-bold py-1 px-3 rounded text-white min-w-[3rem]"
                                        :class="getStockStatusColor(getStock(prod.name))">
                                        {{ getStock(prod.name) }}
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-show="currentTab === 'history'" class="h-full flex flex-col bg-gray-100 p-4 overflow-y-auto pb-24">
                <h2 class="text-xl font-bold mb-4 ml-1">交易紀錄</h2>
                <div v-if="transactions.length === 0" class="text-center text-gray-400 mt-10">暫無紀錄</div>
                
                <div v-for="record in sortedTransactions" :key="record.id" class="bg-white p-4 rounded-xl shadow-sm mb-4 border-l-4" 
                     :class="getTransactionColor(record.type)">
                    
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <span class="text-xs font-bold px-2 py-1 rounded" 
                                  :class="getTransactionBadgeClass(record.type)">
                                {{ getTransactionLabel(record.type) }}
                            </span>
                            <span class="text-xs text-gray-400 ml-2">{{ formatDate(record.timestamp) }}</span>
                        </div>
                        <button @click="deleteTransaction(record)" class="text-gray-400 hover:text-red-500 px-2">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>

                    <div class="mb-2 text-sm text-gray-600 bg-gray-50 p-2 rounded flex justify-between items-center group">
                        <span v-if="!record.isEditing" class="italic w-full">{{ record.memo || '無備註' }}</span>
                        <input v-else v-model="record.tempMemo" class="bg-white border p-1 rounded w-full text-sm" />
                        
                        <button v-if="!record.isEditing" @click="startEdit(record)" class="ml-2 text-gray-400 hover:text-blue-500">
                            <i class="fa-solid fa-pen"></i>
                        </button>
                        <button v-else @click="saveEdit(record)" class="ml-2 text-green-500">
                            <i class="fa-solid fa-check"></i>
                        </button>
                    </div>

                    <div class="border-t pt-2 mt-2">
                        <div v-for="item in record.items" class="flex justify-between text-sm py-0.5">
                            <span class="text-gray-700 truncate w-2/3">{{ item.name }}</span>
                            <span class="font-mono">{{ item.qty }}</span>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <nav class="bg-white border-t border-gray-200 flex justify-around items-center safe-bottom py-2 z-20">
            <button @click="currentTab = 'pos'" class="flex flex-col items-center p-2 w-1/4" :class="currentTab === 'pos' ? 'text-blue-600' : 'text-gray-400'">
                <i class="fa-solid fa-cash-register text-xl mb-1"></i>
                <span class="text-[10px]">作業</span>
            </button>
            <button @click="currentTab = 'orders'" class="flex flex-col items-center p-2 w-1/4" :class="currentTab === 'orders' ? 'text-blue-600' : 'text-gray-400'">
                <div class="relative">
                    <i class="fa-solid fa-truck-fast text-xl mb-1"></i>
                    <span v-if="pendingOrders.length > 0" class="absolute -top-1 -right-2 bg-red-500 text-white text-[9px] w-4 h-4 flex items-center justify-center rounded-full">{{ pendingOrders.length }}</span>
                </div>
                <span class="text-[10px]">叫貨單</span>
            </button>
            <button @click="currentTab = 'inventory'" class="flex flex-col items-center p-2 w-1/4" :class="currentTab === 'inventory' ? 'text-blue-600' : 'text-gray-400'">
                <i class="fa-solid fa-boxes-stacked text-xl mb-1"></i>
                <span class="text-[10px]">庫存</span>
            </button>
            <button @click="currentTab = 'history'" class="flex flex-col items-center p-2 w-1/4" :class="currentTab === 'history' ? 'text-blue-600' : 'text-gray-400'">
                <i class="fa-solid fa-clock-rotate-left text-xl mb-1"></i>
                <span class="text-[10px]">紀錄</span>
            </button>
        </nav>

    </div>

    <script>
        const { createApp } = Vue;
        // 產品原始資料 (省略, 請保持與上一個版本相同)
        const RAW_PRODUCTS = [
            {cat:"晶鑽系列",name:"NB-1晶鑽肽撫紋緊緻露",price:3800},
            // ... (請貼上之前完整的產品列表, 為節省篇幅此處省略) ...
            {cat:"精油系列",name:"舒壓除勞水療浴油",price:2600},
        ];
        // 為避免錯誤，使用時請務必填入所有產品資料。
        // 若您直接複製我的代碼，請確保上面的 RAW_PRODUCTS 陣列是完整的。
        // 您可以從上一個版本的代碼中複製 RAW_PRODUCTS 區塊過來。

        const CATEGORY_COLORS = {
            '晶鑽系列': 'bg-gray-300 text-gray-800',
            'NB-1御妍系列': 'bg-amber-800 text-white',
            'NB-1青春系列': 'bg-yellow-500 text-white',
            '山藥系列': 'bg-green-600 text-white',
            'Dr.標靶系列': 'bg-teal-400 text-white',
            '童妍水光系列': 'bg-red-500 text-white',
            'NB-1胜肽水光': 'bg-purple-300 text-purple-900',
            '超效保濕系列': 'bg-gray-700 text-white',
            '生化系列': 'bg-purple-800 text-white',
            '漢方草本系列': 'bg-lime-700 text-white',
            '專業系列': 'bg-blue-600 text-white',
            '精油系列': 'bg-indigo-600 text-white',
        };

        createApp({
            data() {
                return {
                    currentTab: 'pos',
                    mode: 'IN', // IN, OUT, ORDER
                    categories: [],
                    products: RAW_PRODUCTS,
                    activeCategory: '',
                    inventory: {}, 
                    transactions: [],
                    pendingOrders: [], // 新增：等待收貨的清單
                    cart: [],
                    isCartOpen: true,
                    orderMemo: '',
                    inventorySearch: '',
                    showLowStockOnly: false,
                    safeStockThreshold: 3
                }
            },
            created() {
                // 如果 RAW_PRODUCTS 為空(因縮減代碼)，請自行補回。
                // 這裡假設 RAW_PRODUCTS 已經完整。
                this.categories = [...new Set(this.products.map(p => p.cat))];
                this.activeCategory = this.categories[0];
                
                const savedInv = localStorage.getItem('nb1_inventory');
                if (savedInv) this.inventory = JSON.parse(savedInv);
                
                const savedTrans = localStorage.getItem('nb1_transactions');
                if (savedTrans) this.transactions = JSON.parse(savedTrans);

                const savedOrders = localStorage.getItem('nb1_pending_orders');
                if (savedOrders) this.pendingOrders = JSON.parse(savedOrders);
            },
            computed: {
                filteredProducts() {
                    return this.products.filter(p => p.cat === this.activeCategory);
                },
                filteredInventory() {
                    let list = this.products;
                    if (this.inventorySearch) {
                        const term = this.inventorySearch.toLowerCase();
                        list = list.filter(p => p.name.toLowerCase().includes(term));
                    }
                    if (this.showLowStockOnly) {
                        list = list.filter(p => (this.inventory[p.name] || 0) < this.safeStockThreshold);
                    }
                    return list;
                },
                cartTotal() {
                    return this.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                },
                cartItemCount() {
                    return this.cart.reduce((sum, item) => sum + item.qty, 0);
                },
                sortedTransactions() {
                    return [...this.transactions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                }
            },
            methods: {
                getCategoryColor(cat) { return CATEGORY_COLORS[cat] || 'bg-gray-400 text-white'; },
                formatPrice(p) { return p.toLocaleString(); },
                formatDate(dStr) {
                    const d = new Date(dStr);
                    return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}`;
                },
                getStock(name) { return this.inventory[name] || 0; },
                getStockStatusColor(qty) {
                    if (qty <= 0) return 'bg-red-500 text-white';
                    if (qty < this.safeStockThreshold) return 'bg-amber-400 text-white';
                    return 'bg-green-500 text-white';
                },
                getModeLabel(m) {
                    if (m === 'IN') return '進貨';
                    if (m === 'OUT') return '出貨';
                    return '叫貨';
                },
                getCheckoutBtnClass() {
                    if (this.mode === 'IN') return 'bg-green-500 hover:bg-green-600';
                    if (this.mode === 'OUT') return 'bg-red-500 hover:bg-red-600';
                    return 'bg-blue-500 hover:bg-blue-600';
                },
                getTransactionColor(type) {
                    if (type === 'IN') return 'border-green-500';
                    if (type === 'OUT') return 'border-red-500';
                    if (type === 'CORRECT') return 'border-gray-500';
                    return 'border-blue-500'; // ORDER_IN
                },
                getTransactionBadgeClass(type) {
                    if (type === 'IN') return 'bg-green-100 text-green-700';
                    if (type === 'OUT') return 'bg-red-100 text-red-700';
                    if (type === 'CORRECT') return 'bg-gray-100 text-gray-700';
                    return 'bg-blue-100 text-blue-700';
                },
                getTransactionLabel(type) {
                    if (type === 'IN') return '一般進貨';
                    if (type === 'OUT') return '銷售出貨';
                    if (type === 'CORRECT') return '盤點校正';
                    return '叫貨入庫';
                },

                // 核心邏輯
                addToCart(product) {
                    const existing = this.cart.find(item => item.name === product.name);
                    if (existing) existing.qty++;
                    else this.cart.push({ ...product, qty: 1 });
                },
                updateQty(index, change) {
                    this.cart[index].qty += change;
                    if (this.cart[index].qty <= 0) this.cart.splice(index, 1);
                },
                clearCart() {
                    this.cart = [];
                    this.orderMemo = '';
                },
                
                // 結帳/送單
                checkout() {
                    if (this.cart.length === 0) return;

                    // 1. 叫貨模式：只存入 pendingOrders，不改庫存
                    if (this.mode === 'ORDER') {
                        const order = {
                            id: Date.now(),
                            timestamp: new Date().toISOString(),
                            items: JSON.parse(JSON.stringify(this.cart)),
                            total: this.cartTotal,
                            memo: this.orderMemo
                        };
                        this.pendingOrders.push(order);
                        this.saveToLocal();
                        this.clearCart();
                        alert('叫貨單已建立！請至「叫貨單」分頁查看。');
                        return;
                    }

                    // 2. 進出貨模式：直接改庫存
                    const transaction = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: this.mode,
                        items: JSON.parse(JSON.stringify(this.cart)), 
                        total: this.cartTotal,
                        memo: this.orderMemo,
                        isEditing: false, 
                        tempMemo: ''
                    };

                    this.cart.forEach(item => {
                        const current = this.inventory[item.name] || 0;
                        if (this.mode === 'IN') this.inventory[item.name] = current + item.qty;
                        else this.inventory[item.name] = current - item.qty;
                    });

                    this.transactions.push(transaction);
                    this.saveToLocal();
                    this.clearCart();
                    alert(this.mode === 'IN' ? '進貨完成！' : '出貨完成！');
                },

                // 叫貨單功能：確認收貨
                receiveOrder(order) {
                    if (!confirm('確認貨品已送達？這將會把數量加入庫存。')) return;

                    // 1. 加庫存
                    order.items.forEach(item => {
                        const current = this.inventory[item.name] || 0;
                        this.inventory[item.name] = current + item.qty;
                    });

                    // 2. 建立歷史紀錄 (標記為叫貨入庫)
                    const transaction = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'ORDER_IN',
                        items: order.items,
                        total: order.total,
                        memo: `[到貨] ${order.memo || ''}`,
                        isEditing: false,
                        tempMemo: ''
                    };
                    this.transactions.push(transaction);

                    // 3. 從叫貨清單移除
                    this.pendingOrders = this.pendingOrders.filter(o => o.id !== order.id);
                    
                    this.saveToLocal();
                    alert('已完成入庫！');
                },
                deletePendingOrder(id) {
                    if(confirm('確定要刪除此叫貨單嗎？(尚未入庫)')) {
                        this.pendingOrders = this.pendingOrders.filter(o => o.id !== id);
                        this.saveToLocal();
                    }
                },

                // 其他輔助功能 (盤點、刪除紀錄、CSV)
                quickEditStock(prod) {
                    const currentQty = this.getStock(prod.name);
                    const newQtyStr = prompt(`盤點「${prod.name}」實際數量：`, currentQty);
                    if (newQtyStr === null) return;
                    const newQty = parseInt(newQtyStr);
                    if (isNaN(newQty) || newQty < 0) { alert("無效數字"); return; }
                    if (newQty === currentQty) return;

                    const transaction = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'CORRECT',
                        items: [{ name: prod.name, qty: newQty, oldQty: currentQty }],
                        total: 0,
                        memo: `快速盤點修正 (${currentQty} -> ${newQty})`,
                        isEditing: false, tempMemo: ''
                    };
                    this.inventory[prod.name] = newQty;
                    this.transactions.push(transaction);
                    this.saveToLocal();
                },
                deleteTransaction(record) {
                    if(!confirm('刪除紀錄將自動校正庫存，確定？')) return;
                    // 若是 "ORDER_IN" 或 "IN"，刪除要扣庫存
                    // 若是 "OUT"，刪除要加庫存
                    if (record.type === 'CORRECT') {
                        alert('盤點紀錄僅刪除資料，不影響當前庫存');
                    } else {
                        const isStockIn = (record.type === 'IN' || record.type === 'ORDER_IN');
                        record.items.forEach(item => {
                            const current = this.inventory[item.name] || 0;
                            if (isStockIn) this.inventory[item.name] = current - item.qty;
                            else this.inventory[item.name] = current + item.qty;
                        });
                    }
                    this.transactions = this.transactions.filter(t => t.id !== record.id);
                    this.saveToLocal();
                },
                startEdit(record) { record.tempMemo = record.memo; record.isEditing = true; },
                saveEdit(record) { record.memo = record.tempMemo; record.isEditing = false; this.saveToLocal(); },
                toggleLowStockFilter() { this.showLowStockOnly = !this.showLowStockOnly; },
                exportCSV() {
                    const headers = ["類別", "產品名稱", "建議售價", "目前庫存"];
                    const rows = this.products.map(p => [p.cat, p.name, p.price, this.getStock(p.name)]);
                    let csvContent = "data:text/csv;charset=utf-8,\uFEFF" + headers.join(",") + "\n" + rows.join("\n");
                    const link = document.createElement("a");
                    link.setAttribute("href", encodeURI(csvContent));
                    link.setAttribute("download", `NB1_Inv_${new Date().toISOString().slice(0,10)}.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                },
                saveToLocal() {
                    localStorage.setItem('nb1_inventory', JSON.stringify(this.inventory));
                    localStorage.setItem('nb1_transactions', JSON.stringify(this.transactions));
                    localStorage.setItem('nb1_pending_orders', JSON.stringify(this.pendingOrders));
                }
            }
        }).mount('#app');
        
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => {
                     // 偵測到新版本時的處理
                     reg.onupdatefound = () => {
                         const installingWorker = reg.installing;
                         installingWorker.onstatechange = () => {
                             if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                 // 新內容已安裝，提示使用者重新整理
                                 console.log('New content is available; please refresh.');
                             }
                         };
                     };
                });
        }
    </script>
</body>
</html>
